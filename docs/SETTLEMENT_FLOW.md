# Deposit → Settlement Flow

**Updated**: November 19, 2025  
**Status**: Baseline automation live (manual deposits + settlement worker)

This guide explains how Telegram Stars payments progress through manual TON deposits, confirmation monitoring, and automated settlements. Use it as the single reference for configuring the worker stack and validating webhook delivery.

---

## 1. High-Level Flow

1. **Payment recorded** – `PaymentService` stores the successful Telegram invoice with status `received`.
2. **Deposit address issued** – `WalletManagerService.createDepositAddress()` registers a row in `manual_deposits`, tying the payment to a custody wallet address plus `min_confirmations`.
3. **User sends TON** – Developer instructs their customer to transfer the required TON amount to the provided address (typically surfaced inside the Telegram bot or dashboard).
4. **Deposit monitoring** – `DepositMonitorService` (running inside `npm run worker:monitor --workspace=@tg-payment/core`) polls the TON blockchain via `TonBlockchainService.monitorDeposits()` and matches inbound transfers to rows in `manual_deposits`.
5. **Conversion unblocked** – Confirmed deposits move the parent payment to `converting` and set the related conversion’s `settlement_status` to `ready`/`phase2_committed`.
6. **Settlement batch** – `SettlementService` batches completed conversions, creates/updates `settlements` rows, and marks `payments` as `settled` before emitting `settlement.completed` webhooks.

Key database artifacts:

- `manual_deposits` (migration `010`): Tracks custody wallet deposits and confirmations.
- `conversions`: Gains `settlement_status` + `settlement_id` columns to coordinate downstream payouts.
- `settlements`: Stores fiat payout metadata generated by `SettlementService`.

---

## 2. Worker Setup

```bash
# 1) Ensure migrations are up to date
npm run migrate

# 2) Provide TON + webhook secrets in .env
export DATABASE_URL=postgresql://...
export TON_WALLET_MNEMONIC="word1 ... word24"
export WALLET_ENCRYPTION_KEY=0123abcd... (64 hex chars)
export TON_API_URL=https://toncenter.com/api/v2/jsonRPC
export TON_API_KEY=your_ton_api_key
export WEBHOOK_SECRET=your_shared_hmac_secret

# 3) Launch the combined monitor + settlement worker
npm run worker:monitor --workspace=@tg-payment/core
```

The worker bootstraps:

- `DepositMonitorService` with interval `DEPOSIT_POLL_INTERVAL_MS` (default `30000ms`) and confirmation target `TON_MIN_CONFIRMATIONS` (default `1`).
- `SettlementService` with `SETTLEMENT_BATCH_SIZE` (default `25`) and `SETTLEMENT_INTERVAL_MS` (default `60000ms`).

Each worker process is stateless; horizontal scaling is safe because locking occurs inside PostgreSQL.

---

## 6. Fiat Connector Secrets

While settlements are currently marked as completed automatically, the next milestone is wiring payouts to centralized partners. Populate the following environment variables so the connector services can be enabled without another deploy:

```bash
# Kraken OTC / settlement desk
KRAKEN_API_KEY=pk_live_...
KRAKEN_API_SECRET=sk_live_...

# CoinList institutional payouts
COINLIST_API_KEY=cl_live_...
COINLIST_API_SECRET=cl_secret_...
COINLIST_BASE_URL=https://trade-api.coinlist.co  # override for sandbox if needed
```

These values are now surfaced under `config.fiatConnectors` inside `@tg-payment/core`. The settlement worker can read them to decide whether to route fiat conversions through Kraken, CoinList, or keep the default `AUTO-SETTLED` simulation.

---

## 3. Webhook Events

| Event | Trigger | Payload Highlights |
|-------|---------|--------------------|
| `deposit.confirmed` | `manual_deposits.status` transitions to `confirmed` | `depositId`, `paymentId`, `conversionId`, `txHash`, `amountTon`, `confirmations` |
| `settlement.completed` | `settlements.status` becomes `completed` | `settlementId`, `conversionId`, `fiatAmount`, `currency` |

Webhooks are queued through `WebhookService.queueEvent()` with the shared `WEBHOOK_SECRET`. A dedicated dispatcher worker (with retries/backoff) is still pending; until then, events enqueue for immediate delivery attempts.

---

## 4. Validation & Tests

1. **Unit coverage**

   ```bash
   # Deposit monitor logic (Tx matching + webhook enqueue)
   npm run test --workspace=@tg-payment/core -- --runTestsByPath src/__tests__/unit/deposit-monitor.service.test.ts

   # Settlement batching + webhook emission
   npm run test --workspace=@tg-payment/core -- --runTestsByPath src/__tests__/unit/settlement.service.test.ts

   # Wallet manager integration (custody wallet + manual deposit rows)
   npm run test --workspace=@tg-payment/core -- --runTestsByPath src/__tests__/unit/wallet-manager.service.test.ts
   ```

2. **Manual smoke steps**
   - Create a payment via `packages/api/scripts/test-payment.js` to seed a `payments` row.
   - Call `WalletManagerService.createDepositAddress()` (directly or via API) to issue the deposit instructions and verify the new `manual_deposits` entry.
   - Start `npm run worker:monitor` and send a small TON transfer to the generated address on testnet; watch logs for `✅ Manual deposit confirmed` and `✅ Settlement completed` messages.
   - Inspect `payments`, `conversions`, `settlements`, and `manual_deposits` tables to ensure statuses advanced.

3. **Webhook verification**

   - Point a webhook URL at a request bin (runscope, webhook.site) while supplying the same `WEBHOOK_SECRET`.
   - Confirm headers `x-webhook-event` + `x-webhook-signature` (HMAC SHA-256) arrive and payloads match the schema described above.

---

## 5. Production Checklist

- [ ] `manual_deposits` migration (`010`) applied in all environments.
- [ ] `TON_WALLET_MNEMONIC` + `WALLET_ENCRYPTION_KEY` loaded from a secure secret manager.
- [ ] Worker logs ingested (Datadog/Splunk) with alerts on failures or stalled confirmations.
- [ ] Webhook dispatcher worker (retry/backoff) deployed once ready.
- [ ] Fiat payout connector implemented (currently simulated via `AUTO-SETTLED-*`).

With these steps complete, deposit confirmations and settlement webhooks run end-to-end without touching centralized exchanges.
